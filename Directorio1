import csv
from ListaContactos import *
from datetime import datetime

def merge(izquierda, derecha):
    resultado = []
    i = j = 0

    while i < len(izquierda) and j < len(derecha):
        if (izquierda[i].nombre, izquierda[i].apellidos) <= (derecha[j].nombre, derecha[j].apellidos):
            resultado.append(izquierda[i])
            i += 1
        else:
            resultado.append(derecha[j])
            j += 1

    resultado += izquierda[i:]
    resultado += derecha[j:]

    return resultado

def crear_contacto(fila):
    """
    Crea un objeto de contacto (Alumno, Profesor o Coordinador) a partir de los datos de una fila del archivo CSV.

    Args:
        fila (list): Una lista que contiene los datos de una fila del archivo CSV.

    Returns:
        Alumno | Profesor | Coordinador: El objeto de contacto creado, o None si el tipo de contacto no es válido.
    """
    try:
        tipo = fila[0].capitalize()
        nombre = fila[1]
        apellidos = fila[2]
        nacimiento = datetime.strptime(fila[3], "%d/%m/%Y").date()
        email = fila[4]
        celular = int(fila[5]) if fila[5] else 0
        carrera = fila[6]
        num_cuenta = int(fila[7]) if fila[7] else None
        semestre = int(fila[8]) if fila[8] else None
        materias = fila[9]
        num_profesor = int(fila[10]) if fila[10] else None
        salario = float(fila[11]) if fila[11] else None
        oficina = int(fila[12]) if fila[12] else None
        grupos = fila[13]
        departamento = fila[14]
        num_coordinador = int(fila[15]) if fila[15] else None
        extension = int(fila[16]) if fila[16] else None

        if tipo == "Alumno":
            contacto = Alumno(nombre, apellidos, nacimiento, email, celular, carrera, num_cuenta, semestre,
                              materias)
        elif tipo == "Profesor":
            contacto = Profesor(nombre, apellidos, nacimiento, email, celular, carrera, num_profesor, departamento,
                                salario, oficina, grupos)
        elif tipo == "Coordinador":
            contacto = Coordinador(nombre, apellidos, nacimiento, email, celular, carrera, num_coordinador,
                                   departamento, extension, salario)
        else:
            print(f"Tipo de contacto no válido: {tipo}")
            return None  # Devolver None si el tipo no es válido

        return contacto

    except (ValueError, IndexError) as e:
        print(f"Error al procesar la fila: {fila}")
        print(f"Error: {e}")
        return None  # Devolver None en caso de error

class Directorio:
    def __init__(self):
        self.contactos = Lista()

    def agregar_contacto(self, contacto):
        # Buscar si ya existe un contacto con el mismo nombre y apellidos
        existe = False
        for c in self.contactos:
            if c.nombre == contacto.nombre and c.apellidos == contacto.apellidos:
                existe = True
                break

        # Agregar el contacto si no existe
        if not existe:
            self.contactos.agregar(contacto)
        else:
            print(f"El contacto {contacto.nombre} {contacto.apellidos} ya existe en el directorio.")

    def eliminar_contacto(self, nombre, apellidos):
        for contacto in self.contactos:  # Recorre la lista simplemente ligada
            if contacto.nombre == nombre and contacto.apellidos == apellidos:
                self.contactos.eliminar(contacto)  # Asegúrate que 'eliminar' funciona con listas simplemente ligadas
                return True
        return False

    def buscar_contacto(self, criterio, valor):
        resultados = Lista()
        for contacto in self.contactos:
            if criterio == "nombre":
                if contacto.nombre == valor or contacto.apellidos == valor:
                    resultados.agregar(contacto)
            elif criterio == "celular":
                if contacto.celular == int(valor):  # Convertir a entero si es necesario
                    resultados.agregar(contacto)
            elif criterio == "numero":
                if (isinstance(contacto, Alumno) and contacto.num_cuenta == valor) or \
                        (isinstance(contacto, Profesor) and contacto.num_profesor == valor) or \
                        (isinstance(contacto, Coordinador) and contacto.num_coordinador == valor):
                    resultados.agregar(contacto)
        return resultados  # Devolver la lista de resultados

    def actualizar_contacto(self, nombre, apellidos, nuevo_contacto):
        """Actualiza un contacto existente con nuevos datos."""
        # Buscar el contacto a actualizar usando la nueva función buscar_contactos
        resultados = self.buscar_contacto("nombre", nombre)

        if resultados.esta_vacia():
            print("Contacto no encontrado.")
            return False
        else:
            # Obtener el primer contacto de la lista de resultados (asumiendo que solo habrá uno con ese nombre)
            contacto_a_actualizar = resultados.primero()

            # Verificar si los apellidos coinciden también
            if contacto_a_actualizar.apellidos == apellidos:
                # Reemplazar el contacto original con el nuevo contacto en la lista
                self.contactos.sustituir(contacto_a_actualizar, nuevo_contacto)
                return True
            else:
                print("Contacto no encontrado (apellidos no coinciden).")
                return False  # No se encontró el contacto

    def ordenar_contactos(self, contactos):
        """
        Ordena la lista implementando el algoritmo Merge Sort.

        Args:
            contactos (lista): Lista de objetos Contacto a ordenar.

        Returns:
            lista: Lista de contactos ordenada alfabéticamente por nombre y apellidos.
        """
        if len(contactos) <= 1:
            return contactos

        mitad = len(contactos) // 2
        izquierda = contactos[:mitad]
        derecha = contactos[mitad:]

        izquierda = self.ordenar_contactos(izquierda)
        derecha = self.ordenar_contactos(derecha)

        return merge(izquierda, derecha)

    def listar_contactos(self, criterio=None, valor=None):
        """Lista los contactos usando listas simplemente ligadas,
        opcionalmente filtrando por criterio y valor."""

        lista_resultado = Lista()  # Crear una nueva lista simplemente ligada para los resultados

        actual = self.contactos.inicio  # Empezar desde el inicio de la lista principal
        while actual is not None:
            contacto = actual.elemento
            if criterio is None:  # Si no hay criterio, agregar todos
                lista_resultado.agregar(contacto)
            elif criterio == "tipo":
                if isinstance(contacto, valor):
                    lista_resultado.agregar(contacto)
            elif criterio == "email":
                if isinstance(contacto, (Alumno, Profesor, Coordinador)):
                    lista_resultado.agregar(contacto)
            elif criterio == "carrera":
                if contacto.carrera == valor:
                    lista_resultado.agregar(contacto)
            actual = actual.siguiente  # Avanzar al siguiente nodo

        # Ordenar la lista de resultados (si es necesario)
        # Aquí necesitarías implementar una función de ordenamiento para listas simplemente ligadas
        # lista_resultado = self.ordenar_lista_ligada(lista_resultado)

        # Imprimir los contactos de la lista de resultados
        if not lista_resultado.esta_vacia():
            for contacto in lista_resultado:  # Iterar sobre la lista simplemente ligada
                print(contacto)
        else:
            print("No hay contactos que coincidan con el criterio de búsqueda.")

    def eliminar_por_celular(self, celular):
        for contacto in self.contactos:  # Recorre la lista simplemente ligada
            if contacto and contacto.celular == celular:
                self.contactos.eliminar(contacto)  # Asegúrate que 'eliminar' funciona con listas simplemente ligadas
                return True
        return False

    def eliminar_por_numero(self, tipo, numero):
        for contacto in self.contactos:  # Recorre la lista simplemente ligada
            if contacto and isinstance(contacto, tipo) and (
                    (tipo == Alumno and contacto.num_cuenta == numero) or
                    (tipo == Profesor and contacto.num_profesor == numero) or
                    (tipo == Coordinador and contacto.num_coordinador == numero)
            ):
                self.contactos.eliminar(contacto)  # Asegúrate que 'eliminar' funciona con listas simplemente ligadas

    def vaciar_directorio(self):
        self.contactos.vaciar()
        print("El directorio se ha vaciado.")

    def leer_archivo(self, archivo_csv):
        """
        Lee un archivo CSV y agrega los contactos al directorio.
        """
        try:
            with open(archivo_csv, newline='', encoding='utf-8') as csvfile:
                lector = csv.reader(csvfile)
                next(lector)  # Saltar la primera fila si contiene encabezados
                for fila in lector:
                    contacto = crear_contacto(fila)  # Llamar a la función externa
                    if contacto:  # Agregar solo si se creó un contacto válido
                        self.agregar_contacto(contacto)
                        print(f"Contacto agregado: {contacto}")

        except FileNotFoundError:
            print(f"Error: No se encontró el archivo {archivo_csv}")


    def guardar_archivo(self, archivo_csv):
        contactos = self.listar_contactos()
        if not archivo_csv.endswith(".csv"):
            archivo_csv += ".csv"
        with open(archivo_csv, mode='w', newline='', encoding='utf-8') as csvfile:
            escritor = csv.writer(csvfile)

            # Agregar la fila de encabezados
            encabezados = ["Tipo", "Nombre", "Apellidos", "Nacimiento", "Email", "Celular",
                           "Carrera", "Num_Cuenta", "Semestre", "Materias", "Num_Profesor",
                           "Departamento", "Salario", "Oficina", "Grupos", "Num_Coordinador",
                           "Extension"]
            escritor.writerow(encabezados)

            for contacto in contactos:
                if isinstance(contacto, Alumno):
                    escritor.writerow(
                        ["Alumno", contacto.nombre, contacto.apellidos, contacto.nacimiento.strftime("%d/%m/%Y"),
                         contacto.email, contacto.celular, contacto.carrera, contacto.num_cuenta, contacto.semestre,
                         contacto.materias, "", "", "", "", "", "", ""]
                    )
                elif isinstance(contacto, Profesor):
                    fila = ["Profesor", contacto.nombre, contacto.apellidos, contacto.nacimiento.strftime("%d/%m/%Y"),
                            contacto.email, contacto.celular, contacto.carrera, "", "", "", contacto.num_profesor,
                            contacto.departamento, contacto.salario, contacto.oficina, contacto.grupos, "", ""]
                    escritor.writerow(fila)
                elif isinstance(contacto, Coordinador):
                    fila = ["Coordinador", contacto.nombre, contacto.apellidos,
                            contacto.nacimiento.strftime("%d/%m/%Y"),
                            contacto.email, contacto.celular, contacto.carrera, "", "", "", "",
                            contacto.departamento, contacto.salario, "", "", contacto.extension]
                    escritor.writerow(fila)
